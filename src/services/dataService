// ... (Tus otras constantes parseCSV y STORES_DATA siguen igual) ...

// ==========================================
// SERVICIO DE WOOCOMMERCE (PROXY SEGURO)
// ==========================================
export const sendOrderToWP = async (orderData) => {
    const endpoint = '/.netlify/functions/process-checkout';

    // LIMPIEZA DE DATOS PARA EVITAR RECHAZO
    // Convertimos items a fee lines o items simples para evitar validación de ID
    const cleanLineItems = orderData.line_items.map(item => ({
        name: item.name || "Producto",
        quantity: item.qty || 1,
        total: String(item.price * (item.qty || 1)), // Total de la línea como string
        price: String(item.price) // Unitario
        // No mandamos product_id para evitar error "Invalid product ID"
    }));

    const payload = {
        payment_method: orderData.payment_method,
        payment_method_title: orderData.payment_method_title,
        set_paid: false,
        billing: orderData.billing,
        shipping: orderData.shipping,
        line_items: cleanLineItems,
        customer_note: orderData.customer_note || ""
    };

    try {
        console.log("Enviando a función:", endpoint);
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        // Leemos texto para diagnosticar si es HTML o JSON
        const textResponse = await response.text();
        
        let data;
        try {
            data = JSON.parse(textResponse);
        } catch (e) {
            console.error("Respuesta RAW del servidor:", textResponse);
            throw new Error(`Error del servidor (No es JSON): ${response.status} ${response.statusText}`);
        }

        if (!response.ok) {
            console.error("Error lógico del servidor:", data);
            throw new Error(data.message || 'Error al procesar el pago en el servidor');
        }

        // Éxito - Construir URL de pago
        let paymentUrl = data.payment_url || data.meta_data?.find(m => m.key === '_payment_link')?.value;
        
        if (!paymentUrl && data.id && data.order_key) {
             const baseUrl = "https://novimundo.com.mx"; 
             paymentUrl = `${baseUrl}/checkout/order-pay/${data.id}/?pay_for_order=true&key=${data.order_key}`;
        }
        
        return { ...data, payment_url: paymentUrl };

    } catch (error) {
        console.error("Fallo crítico en checkout:", error);
        throw error;
    }
};
