// ==========================================
// CONFIGURACI√ìN DE DATOS (Google Sheets)
// ==========================================
export const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vReghg6xM6cC5_C3w4ZqkgImVW8lrreL3Oo8c3onylbpDROhRTHldO4OZuN27EKBmkmRjlejhAD2tey/pub?gid=1611639201&single=true&output=csv"; 
export const GOOGLE_SHEET_BEST_SELLERS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vReghg6xM6cC5_C3w4ZqkgImVW8lrreL3Oo8c3onylbpDROhRTHldO4OZuN27EKBmkmRjlejhAD2tey/pub?gid=1914777355&single=true&output=csv";

// ==========================================
// DATOS DE SUCURSALES (Est√°ticos)
// ==========================================
export const STORES_DATA = [
    { 
      id: 1, 
      name: "Novimundo Tonal√°", 
      address: "Av. Rayon Esq 15 de Febrero, Col. Centro, Tonal√°, Chiapas", 
      phone: "966 663 1003", 
      hours: "Lunes a Domingo: 9:00 AM - 6:00 PM", 
      mapUrl: "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3839.883731872898!2d-93.75486592490595!3d16.08200698459469!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x8594950e3d55167b%3A0xe536d3570624773a!2sMuebler%C3%ADa%20Novimundo!5e0!3m2!1ses-419!2smx!4v1736523171120!5m2!1ses-419!2smx" 
    },
    { 
      id: 2, 
      name: "Novimundo Mapastepec (Estaci√≥n)", 
      address: "30560, Dif, 30560 Mapastepec, Chis.", 
      phone: "918 113 7460", 
      hours: "Lunes a Domingo: 9:00 AM - 6:00 PM", 
      mapUrl: "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3846.577232230559!2d-92.89883502491176!3d15.400325485187766!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x858e72e2591b65b1%3A0xb35a9d82121e7d01!2sNovimundo!5e0!3m2!1ses-419!2smx!4v1736523233866!5m2!1ses-419!2smx" 
    },
    { 
      id: 3, 
      name: "Novimundo Mapastepec (Sucursal 2)", 
      address: "Av. Francisco Sarabia, Malucal, 30560 Mapastepec, Chis.", 
      phone: "918 113 7460", 
      hours: "Lunes a Domingo: 9:00 AM - 6:00 PM", 
      mapUrl: "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3846.564554316625!2d-92.89674062491172!3d15.401614085186835!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x858e72e19662703f%3A0x7707c57c4f4f4632!2sMuebler%C3%ADa%20Novimundo%20Sucursal%202!5e0!3m2!1ses-419!2smx!4v1736523315663!5m2!1ses-419!2smx" 
    },
    { 
      id: 4, 
      name: "Novimundo Escuintla", 
      address: "AV. MORELOS SUR, Calle Ignacio Zaragoza Pte., 30600 Escuintla, Chis.", 
      phone: "966 115 8295", 
      hours: "Lunes a Domingo: 9:00 AM - 6:00 PM", 
      mapUrl: "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3847.781603504381!2d-92.65882312491278!3d15.277840185289945!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x858e0d6501712a3d%3A0x5e85c1860c238b6d!2sNovimundo%20Escuintla!5e0!3m2!1ses-419!2smx!4v1736523363412!5m2!1ses-419!2smx" 
    },
    { 
      id: 5, 
      name: "Novimundo Tres Picos", 
      address: "C. Hidalgo 25B, Tres Picos, 30515 Tres Picos, Chis.", 
      phone: "966 104 7336", 
      hours: "Lunes a S√°bado: 9:00 AM - 6:00 PM", 
      mapUrl: "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3842.102371900326!2d-93.5413110249079!3d15.892013884761453!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x85938b8df2f427f7%3A0xd64455855f30e674!2sNovimundo!5e0!3m2!1ses-419!2smx!4v1736523412351!5m2!1ses-419!2smx" 
    }
];

// ==========================================
// PARSER CSV
// ==========================================
export const parseCSV = (csvText) => {
    if (!csvText || csvText.trim() === "") return [];
    const lines = csvText.trim().split(/\r\n|\n/);
    if (lines.length === 0) return [];
    const firstLine = lines[0];
    const separator = firstLine.includes('\t') ? '\t' : ',';
    const rawHeaders = firstLine.split(separator).map(h => h.trim().toLowerCase().replace(/^"|"$/g, ''));
    
    // Mapeo flexible (AGREGAMOS 'stock')
    const headerMap = { 
        'id': 'id', 'sku': 'id', 
        'nombre': 'name', 'producto': 'name', 'nombre del producto': 'name', 
        'precio': 'price', 'costo': 'price', 
        'categoria': 'category', 'categor√≠a': 'category', 
        'subcategoria': 'subcategory', 'subcategor√≠a': 'subcategory', 
        'marca': 'brand', 
        'imagen': 'image', 'foto': 'image', 'url imagen': 'image', 
        'imagen2': 'image2', 'foto2': 'image2', 
        'imagen3': 'image3', 'foto3': 'image3', 
        'descripcion': 'description', 'descripci√≥n': 'description', 
        'tag': 'tag', 'etiqueta': 'tag', 
        'rating': 'rating',
        'stock': 'stock', 'inventario': 'stock', 'disponible': 'stock' // NUEVO
    };
    
    const columnIndices = {};
    rawHeaders.forEach((header, index) => { const mappedKey = headerMap[header]; if (mappedKey) columnIndices[mappedKey] = index; });
    
    const parsedItems = lines.slice(1).map(line => {
        let values;
        if (separator === '\t') { values = line.split('\t'); } else { values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); }
        const cleanValues = values.map(v => v ? v.replace(/^"|"$/g, '').trim() : '');
        if (cleanValues.length < 2) return null;
        
        const obj = {};
        Object.keys(columnIndices).forEach(key => {
            const index = columnIndices[key];
            let value = cleanValues[index];
            if (value !== undefined) {
                if (key === 'price' || key === 'id') { 
                    value = value.replace(/[$,]/g, ''); 
                    value = Number(value) || 0; 
                }
                obj[key] = value;
            }
        });

        // Valores por defecto
        if (!obj.rating) obj.rating = 5;
        if (!obj.image) obj.image = "https://via.placeholder.com/300?text=Sin+Imagen";
        if (obj.category === 'linea_blanca') obj.category = 'L√≠nea Blanca';
        
        // L√ìGICA DE STOCK (NUEVO) üö¶
        // Si la columna stock dice "si", "s√≠", "true" o "1", est√° disponible.
        // Si dice "no", "0" o est√° vac√≠a, NO est√° disponible.
        if (obj.stock) {
            const stockValue = String(obj.stock).toLowerCase().trim();
            obj.inStock = ['si', 's√≠', 'true', '1', 'yes'].includes(stockValue);
        } else {
            // Si no hay columna stock en el excel, asumimos que S√ç hay stock (por compatibilidad)
            // O puedes poner false si prefieres que por defecto est√© agotado.
            obj.inStock = false; 
        }

        if (!obj.name && !obj.price) return null;
        return obj;
    }).filter(item => item !== null);
    
    const uniqueItems = []; const seenIds = new Set();
    parsedItems.forEach(item => { if (!seenIds.has(item.id)) { seenIds.add(item.id); uniqueItems.push(item); } });
    return uniqueItems;
};

// ==========================================
// SERVICIO DE WOOCOMMERCE (PROXY SEGURO)
// ==========================================
export const sendOrderToWP = async (orderData) => {
    const endpoint = '/.netlify/functions/process-checkout';

    // ‚ö†Ô∏è ¬°IMPORTANTE! PON AQU√ç EL ID QUE VISTE EN WORDPRESS ‚ö†Ô∏è
    const GENERIC_PRODUCT_ID = 75; 

    if (GENERIC_PRODUCT_ID === 0) {
        console.error("‚ö†Ô∏è PRECAUCI√ìN: No has configurado el ID del producto gen√©rico en dataService.js");
    }

    // LIMPIEZA DE DATOS PARA EVITAR RECHAZO
    const cleanLineItems = orderData.line_items.map(item => {
        const quantity = Number(item.quantity || item.qty || 1);
        const price = Number(item.price || 0);
        
        return {
            // TRUCO: Usamos el ID del producto comod√≠n para que WP acepte la orden
            product_id: GENERIC_PRODUCT_ID,
            
            // Pero enviamos el nombre y precio REALES del Excel
            name: item.name || "Producto sin nombre",
            quantity: quantity,
            
            // Forzamos el total para que WooCommerce cobre esto y no $1.00
            total: String(price * quantity), 
            price: String(price)
        };
    });

    const payload = {
        payment_method: orderData.payment_method,
        payment_method_title: orderData.payment_method_title,
        set_paid: false,
        billing: orderData.billing,
        shipping: orderData.shipping,
        line_items: cleanLineItems,
        customer_note: orderData.customer_note || ""
    };

    try {
        console.log("üöÄ Iniciando checkout con Producto Comod√≠n ID:", GENERIC_PRODUCT_ID);
        
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const textResponse = await response.text();
        
        if (response.status === 404) {
            throw new Error("El sistema de pagos no est√° disponible temporalmente (Error 404).");
        }

        let data;
        try {
            data = JSON.parse(textResponse);
        } catch (e) {
            console.error("Respuesta RAW:", textResponse);
            throw new Error(`Error del servidor (No es JSON): ${response.status}`);
        }

        if (!response.ok) {
            console.error("Error l√≥gico del servidor:", data);
            throw new Error(data.message || 'Error al procesar el pago.');
        }

        // √âxito - Construir URL de pago
        let paymentUrl = data.payment_url || data.meta_data?.find(m => m.key === '_payment_link')?.value;
        
        if (!paymentUrl && data.id && data.order_key) {
             const baseUrl = "https://novimundo.com.mx"; 
             paymentUrl = `${baseUrl}/checkout/order-pay/${data.id}/?pay_for_order=true&key=${data.order_key}`;
        }
        
        return { ...data, payment_url: paymentUrl };

    } catch (error) {
        console.error("Fallo cr√≠tico en checkout:", error);
        throw error;
    }
};
